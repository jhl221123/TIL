# 연관관계 매핑

**객체와 테이블, 각각의 연관관계의 차이를 극복하기 위한 방법**

* 데이터 중심으로 설계할 경우, 객체 대신 식별자를 가져야 하기 때문에 객체의 협력 관계를 만들 수 없다.
* 객체의 참조를 테이블의 외래 키와 매핑함으로써 객체지향적으로 설계할 수 있게 된다.

## 단방향 연관관계

**한쪽만 참조하는 연관관계**

* 객체는 단방향으로만 참조가 가능하다.
* 설계는 최대한 단방향 매핑으로 끝내는 것이 좋다.

## 양방향 연관관계

**양쪽 모두, 서로 참조하는 연관관계**

* 테이블은 외래키를 통해 양방향 연관관계를 가진다.
* 객체는 연관관계 주인을 정해, 두 개의 단방향 관계를 양방향 관계처럼 만들 수 있다.
* 양쪽 모두 고려해야 하기 때문에 복잡도가 증가한다.
* 반드시 역방향으로 참조해야 하는 경우만 고려하는 것이 좋다.

### 주의사항

* toString(), json 등, 주의해서 사용하지 않으면 무한 루프에 빠질 수 있다.
    * lombok의 toString()은 사용하지 마라.
    * 컨트롤러에 엔티티를 노출시키지 마라.

## 연관관계의 주인

**객체의 참조와 테이블의 외래키의 차이를 극복하기 위한 개념**
* 외래키는 **양방향 관계**이며, 외래키 하나로 조인이 가능하다. (양방향보다는 연결)
* 참조는 단방향 관계로, 양방향으로 참조하기 위해서는 **두 개의 단방향 관계**를 맺어야 한다.
    * 따라서 객체의 경우, 두 가지 참조 중 실제 테이블과 연결할 참조 즉, 연관관계의 주인을 지정해야 한다.
* 연관관계의 주인만 참조값을 등록하고 수정할 수 있으며, **주인이 아니면 조회만 가능**하다.
* 주인이 아닌 경우, mappedBy 속성으로 관계의 주인을 지정해야 한다.
* **연관관계의 주인은 실제 외래키가 있는 테이블** 즉, Many에 해당하는 엔티티로 지정하는 것을 권장한다.
    * 외래키가 없는 곳을 주인으로 정하면 변경사항 발생 시, 다른 테이블로 쿼리가 나가기 때문에 혼란을 야기할 수 있다.
    * 주인을 지정하는 것은 **비즈니스적으로 우위에 있는 것이 아니라** 외래키를 가진 테이블과 매핑하는 작업이다.

### 주의사항

* 양방향 연관관계의 경우, 하나의 메서드를 통해 양쪽을 함께 수정해주는 것이 좋다.
    * 연관관계의 주인만 변경하면, 영속성 컨텍스트 내부에서 데이터 불일치 현상이 발생할 수 있다.
    * 테스트 수행 시, 데이터 정합성 문제가 발생한다.
    * 양쪽을 동시에 변경하는 연관관계 편의 메서드는 둘 중 한 곳에만 존재해야 한다.