# 리눅스 컨테이너

**운영체제 수준의 가상화 기술**

* 별도의 하드웨어 에뮬레이션 없이 리눅스 커널을 공유해 컨테이너를 실행한다.
  * 커널 기능을 통해 프로세스 환경을 격리한다.
  * 게스트OS 관리가 필요하지 않다.

## 주요 특징

### 빠른 속도와 효율성

* 하드웨어 에뮬레이션이 없기 때문에 아주 빠르게 실행된다.
* 프로세스 격리를 위해 아주 약간의 오버헤드가 있지만 일반적인 프로세스를 실행하는 것과 거의 차이가 없다.
* 하나의 머신에서 프로세스 만큼 많이 실행하는 것이 가능하다.

### 높은 이식성(portability)

* 모든 컨테이너는 호스트의 환경이 아닌 독자적인 실행 환경을 가지고 있다.
* 이 환경은 파일들로 구성되며, 이미지 형식으로 공유될 수 있다.
* 리눅스 커널을 사용하고 같은 컨테이너 런타임을 사용할 경우, 컨테이너의 실행 환경을 공유하고 손쉽게 재현할 수 있다.

### 상태를 가지지 않음(stateless)

* 컨테이너가 실행되는 환경은 독립적이기 때문에 다른 컨테이너에게 영향을 주지 않는다.
* 도커와 같이 이미지 기반으로 컨테이너를 실행하는 경우, 특정 실행 환경을 쉽게 재사용할 수 있다.

## 컨테이너의 종류

### 시스템 컨테이너

* 컨테이너 기술들을 사용해 운영체제 위에 하드웨어 가상화 없이 **또다른 운영체제를 실행**
* 일반적인 리눅스처럼 init 프로세스 등을 사용해서 다수의 프로세스가 같은 환경을 공유하는 것을 목표
* 시스템 컨테이너를 지향하는 컨테이너 런타임으로 LXC와 LXD가 대표적

### 애플리케이션 컨테이너

* 컨테이너 기술을 활용해 하나의 **애플리케이션(프로세스)를 실행**하는 것을 목표
* 독립적인 환경을 가진다는 점에서는 시스템 컨테이너와 동일
  * 오직 하나의 프로세스만 실행한다는 점에서 확장이 쉽고 관리 요소가 거의 없다.
* 대표적인 애플리케이션 컨테이너 런타임으로는 Docker가 있다.

## 컨테이너에서 사용하는 프로세스 격리 기능

### Linux namespace

* 특정 프로세스의 리눅스 리소스 접근을 제어하기 위해 사용되는 기능이다.
* 네임스페이스는 리소스 별로 존재한다.
  * IPC, 마운트, 네트워크, PID, 사용자, UTS, 컨트롤 그룹 등
* 시스템 상에서 실행되는 프로세스들은 기본적으로 init 프로세스의 네임스페이스를 공유한다.
  * 시스템콜이나 unshare 명령어를 사용해 리소스 별로 네임스페이스를 분리하는 것이 가능

#### PID 네임스페이스

* 프로세스의 ID를 격리할 수 있는 네임스페이스
* 프로세스 ID를 격리해서 마치 **컨테이너가 init 프로세스인 것처럼 실행** 가능

#### 네트워크 네임스페이스

* 프로세스 별로 고유한 네트워크 환경을 구축할 수 있도록 지원
* 프로세스에 전용 IP를 할당하거나 네트워크 인터페이스를 추가하고 설정 가능
* 네트워크 네임스페이스는 ip 명령어로 조작 가능

### 루트 디렉터리 격리와 chroot

* 컨테이너는 호스트의 파일 시스템이 아닌 별도의 실행 환경을 가지고 있다.
* 이 때 사용되는 기술이 바로 루트 디렉터리 격리 기술로 chroot, pivot_root와 같은 시스템 콜이 이용된다.
* 이를 통해 **프로세스가 바라보는 루트 디렉터리를 파일 시스템 상의 특정한 디렉터리로 변경**하는 것이 가능하다.
  * 프로세스가 액세스 할 수있는 디렉토리를 제한

### 컨트롤 그룹(cgroups)

* 프로세스의 리소스를 격리하고 사용을 제어하는 기능
  * 프로세스에서 사용 가능한 CPU, 메모리, 네트워크 대역폭, 디스크 I/O 등을 그룹 단위로 제어
  * 자원 제한 : 특정 프로세스의 메모리 사용량을 제한.
  * 우선 순위 : 특정 프로세스에 더 많은 CPU와 디스크 I/O 처리량을 할당.
  * 기록 : 프로세스가 자원을 얼마나 사용하고 있는지 측정.
  * 제어 : 프로세스를 멈추거나, 프로세스의 체크포인트를 설정해주거나 재시작 가능.
* 컨테이너에서만 사용되는 기능이 아닌, 리눅스 시스템에서 프로세스 관리를 위해 일반적으로 사용하는 기능

### 리눅스 캐퍼빌리티(Linux capabilities)

* 프로세스의 권한을 제어하는 기능
* 리눅스의 프로세스는 크게 두 가지로 구분
  * 루트 권한(사용자 ID 0)으로 실행되는 특권 프로세스
  * 일반 사용자(사용자 ID 0 이외)가 실행하는 비특권 프로세스
* 루트의 권한을 세분화해서 프로세스 적용할 수 있도록 만든 기능이 Linux capabilities
* 컨테이너 런타임에서도 일부 루트 권한이 필요한 경우, 리눅스 캐퍼빌리티를 사용해 필요한 권한을 지정하는 방식을 지원

### 유니온 마운트(Union Mount)

* 계층화된 파일 시스템을 구현
* 컨테이너에 필수적인 기능은 아니지만, 도커에서 이미지 구현에 사용하면서 필수적인 기능으로 자리잡았다.
* 유니온 마운트를 사용해 **효율적인 이미지 구현이 가능**
  * 또한 이미지 빌드 과정에서 캐시를 사용하거나, 이미지를 관리하는 데도 이점이 있다.
