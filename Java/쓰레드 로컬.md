# 쓰레드 로컬

해당 쓰레드만 접근할 수 있는 특별한 저장소로 쓰레드 로컬을 사용해 메소드 호출 시 매개 변수를 넘기지 않고 값을 공유할 수 있으며 동시성 문제를 해결할 수 있다.

- 동시성 문제: 여러 쓰레드가 동시에 같은 인스턴스의 필드 값을 변경하면서 발생하는 문제로 트래픽이 많을수록 자주 발생한다. 값 변경 없이 읽기만 하거나, 지역 변수를 사용하는 경우에는 동시성 문제가 발생하지 않는다.


아래 그림처럼 두 명의 사용자가 동시에 같은 인스턴스의 필드에 이름을 저장하는 경우 먼저 보관되어 있던 userA는 제거되고 userB가 저장된다.

![Alt text](<이미지\동시성 문제.png>)

이후 userA를 저장한 사용자는 userB를 반환받으며 저장한 값과 조회한 값이 다른 문제가 발생한다.

이런 경우 쓰레드 로컬을 사용하면 쓰레드 전용 저장 공간에 값이 저장되며 동시성 문제를 해결할 수 있다.

![Alt text](<이미지\동시성 문제 해결.png>)


- ThreadLocal 사용법
  - 저장: ThreadLocal.set(xxx)
  - 조회: ThreadLocal.get()
  - 제거: ThreadLocal.remove()


## 쓰레드 로컬 사용 시 주의사항
쓰레드 로컬을 사용한 후에는 ThreadLocal.remove()를 호출해서 쓰레드 로컬에 저장된 값을 제거해 주어야 한다. 단일 쓰레드 환경에서는 수행이 끝나면 해당 쓰레드가 사라지지만 WAS의 경우 쓰레드 생성 비용이 비싸기 때문에 사용이 끝난 쓰레드는 풀에 반환된다. 이때 쓰레드 로컬을 제거하지 않으면 다음 클라이언트가 해당 쓰레드를 사용할 때 쓰레기 값이 들어있게 된다. 이런 문제를 예방하기 위해 요청 처리가 끝나고 반드시 쓰레드 로컬을 제거해야 한다.
