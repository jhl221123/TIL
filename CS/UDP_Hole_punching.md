# UDP Hole punching

**사설 IP 간의 통신을 하기 위해 공인 IP 사이에 통로를 뚫는 기법**

* 서로 다른 네트워크에 존재하는 호스트가 통신하려면 적어도 한 쪽은 공인 IP를 가지고 있어야 한다.
* 양쪽 모두 공인 IP를 가지지 않는다면, 출발지에서 NAT을 이용해서 사설 IP를 공인 IP로 전환한다고 해도 목적지의 공인 IP를 모르기 때문에 요청을 보낼 수가 없다.


## 중개서버를 이용한 Hole punching

제 3의 중개서버를 통해 서로의 공인 IP 주소를 교환할 수 있다.

![Alt text](<이미지/UDP Hole punching.png>)

1. 각 호스트가 중개서버에 전환된 공인 IP를 등록한다. 이 과정에서 NAT에 호스트의 사설 IP, 이에 대응하는 공인 IP가 저장된다.

2. 둘 중 하나가 통신을 개시하면 중개서버가 양쪽에 상대방의 공인 IP를 전달한다.

3. 양쪽에서 Hole punching 패킷(UDP)을 상대방의 공인 IP 주소로 계속해서 보낸다.

4. 처음에는 NAT에 상대의 공인 IP가 매핑되어 있지 않기 때문에 막히지만 시간이 지나면 뻥하고 뚫린다.

5. 이후부터 서로의 공인 IP를 거쳐 데이터를 주고 받을 수 있다.

## Hole punching이 불가능한 경우

* 기업용 혹은 3G/LTE는 불가
* 이중으로 공유기가 설치된 경우 상황에 따라 불가