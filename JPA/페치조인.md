# 페치조인

**연관된 엔티티와 컬렉션을 한 번의 SQL로 조회하는 기능**

* DB에서 제공하는 SQL 종류가 아니다.
* JPQL에서 성능 최적화를 위해 제공하는 기능
* JPQL과 달리 조회 대상과 조인 대상의 정보를 모두 가져온다.
* join fetch 명령어로 사용

``` sql
select m from Member m join fetch m.team t
```

## 장점

* 지연로딩으로 인한 N+1 문제를 해결할 수 있다.
* 엔티티의 글로벌 로딩 전략(LAZY, EAGER) 보다 우선이기 때문에 지연로딩을 기본으로 필요한 부분만 사용함으로써 성능 최적화를 도모할 수 있다.


## 한계

* 페치조인 대상에는 별칭을 줄 수 없다.
    * 정확히는 대상에서 추가적으로 탐색해서는 안된다.
    * JPA는 페치조인 대상이 온전히 조회되는 것을 가정하고 설계되었다.
    * 별칭을 주는 것은 JPA 설계의도에 벗어나기 때문에 예측하지 못한 상황이 발생할 수 있다.
* 둘 이상의 컬렉션은 페치조인 할 수 없다.
    * 데이터 뻥튀기 등 정합성 문제가 발생한다.
* 컬렉션을 페치조인 하면 페이징 API를 사용할 수 없다.(컬렉션을 페치조인 한다는 것은 일대다를 의미)
    * 데이터 중복으로 인해 페이징 신뢰성이 떨어지게 된다.
    * 하이버네이트는 신뢰성 문제를 해결하기 위해 **모든 데이터를 메모리에서 페이징처리 한다.(심각)**
    * 일대일, 다대일과 같은 단일 값으로 페치조인 한다면 상관없다.
* 결국 엔티티 그래프가 유지되는 상황에서만 유용하게 사용할 수 있다.
    * 연관관계가 없는 복잡한 통계 쿼리의 경우, 그냥 일반 조인을 사용하고 DTO로 조회하는 것이 더 효과적이다.

## 일대다 조인의 주의사항

* 일대다 조인 상황에서 중복 데이터가 발생할 수 있다.
* DB의 distinct는 모든 데이터가 동일해야만 중복 데이터를 제거한다.
* 이런 문제를 해결하기 위해 JPA만의 distinct를 제공한다.
    * 조회된 결과에서 식별자가 동일한 엔티티는 중복으로 간주하고 제거된다.