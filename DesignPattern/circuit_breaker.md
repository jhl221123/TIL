# 서킷 브레이커 패턴

**문제가 전파되는 것을 방지하기 위해 요청을 차단하는 패턴**

* 문제가 발생한 지점을 감지하고 실패하는 요청을 계속하지 않도록 방지한다.
  * 시스템의 장애 확산을 막고, 장애 복구를 돕는다. 
  * 클라이언트가 실패할 작업으로 인해 불필요하게 대기하지 않도록 한다.
* 주로 외부 서비스에 의한 문제를 방지하기 위해 사용한다.
  * MSA 환경에서 필수 패턴

## 동작 원리

* circuit breaker는 회로 차단기를 뜻하며, 전류의 흐름을 막아 문제 상황을 방지한다.
  * 회로 차단기를 연다는 것은 문제가 생겨 흐름을 차단한 것을 의미한다.
* `Closed`, `Open`, `Half Open` 3가지 상태가 존재
  * `Closed`: 정상
  * `Open`: 외부 장애 발생
  * `Half Open`: `Open` 상태 이후 일정 시간이 지난 상태
  * `Open` 상태에서 일정 시간이 지나면 자동으로 `Half Open` 상태가 된다.
  * `Half Open` 상태가 되었는데 외부 서버가 복구되지 않았다면, 요청은 실패하고 다시 `Open` 상태로 변경된다.
* 장애 발생 기준은 크게 두 가지가 있으며, 규칙에 따른 임계치가 넘어갈 경우 회로가 열린다.
  * `slow call`: 지정된 시간보다 오래 걸린 요청
  * `failure call`: 실패하거나 오류를 응답받은 요청
  * n초 이상 혹은 n번 이상 기준을 정하고 해당 기준에 따라 회로를 열거나 **닫을 수** 있다.
    * 차단하는 것과 마찬가지로 일정 기준만큼 성공하면 다시 회로를 닫을 수 있다.

## 장점

### 장애 감지 및 격리

* 장애가 발생한 서비스에 더 이상 요청을 보내지 않도록 차단함으로써 시스템 안정성을 높인다.
  * 장애가 발생한 서비스를 호출하면 `timeout`만큼 대기한다.
  * 대기하는 동안 쓰레드, 메모리, CPU 등의 자원을 점유한다.
  * 결국 시스템 리소스를 부족하게 만들어 장애를 유발한다.
    * 장애의 전파

### 자동 시스템 복구

* 요청이 차단되면 해당 서비스가 정상인지 주기적으로 검사한다.
  * 해당 서비스가 복구되면 차단이 해제되고, 정상적으로 요청을 보내게 된다.
  * 시스템이 자동으로 해주기 때문에 개발자가 신경쓰지 않아도 된다.

### 장애 서비스의 부하 감소

* 외부 서비스가 다운된 것은 아니지만 요청이 밀린 경우, 계속해서 요청을 보내면 상황을 악화시킨다.
  * 요청을 차단해서 서비스를 안정화 시킬 수 있다.

### 장애 대안 커스터마이징

* 장애 발생 시, 다른 대안을 미리 지정해 둘 수 있다.
  * 다른 소스를 통해 값을 얻도록 한다.
  * 서킷 브레이커가 자체적으로 캐싱해 둔 값으로 응답한다.