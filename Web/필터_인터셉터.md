# 필터와 인터셉터

웹 브라우저에서 요청한 기능을 수행하기 전, 권한 인증이나 공통 관심사 등의 작업을 미리 처리하기 위해 사용한다. 특히 HttpServletRequest를 제공하기 때문에 웹과 관련된 공통 관심사를 편리하게 처리할 수 있다. 

> HttpServletRequest<br>
HTTP 헤더, URL 등 요청에 대한 정보들을 가지고 있다.

# 필터

서블릿이 제공하는 기능으로 JSP, 서블릿을 실행하기 전에 특정 작업을 미리 처리할 수 있다.

* 사용자 인증, 접근에 대한 로깅 등의 공통 기능을 처리할 수 있다.

* @WebFilter 어노테이션을 사용하면 자동으로 필터가 등록된다.

* 등록된 필터는 서블릿 컨테이너에서 싱글톤 객체로 관리된다.

#### 필터의 정상 흐름

![Alt text](<이미지/필터 정상 흐름.png>)

* 필터를 적용하면 필터가 호출 된 다음에 서블릿이 호출된다.

* 웹 브라우저와 최종 자원 사이에 위치하며, 요청과 응답을 변경하거나 취소할 수 있다.

#### 필터 제한

![Alt text](<이미지/잘못된 요청 필터 처리.png>)

* 필터에서 적절하지 않은 요청이라고 판단하면, 요청한 자원에 접근하지 못한다. 즉, 필터 체인의 흐름대로 수행하지 않고 다른 자원의 결과를 응답으로 전송할 수도 있다.

#### 필터 체인

![Alt text](<이미지/필터 체인.png>)

* 하나 이상의 필터를 사용할 수 있으며, 여러 개의 필터가 모여 필터 체인을 형성한다.

* 필터 체인을 통해 변경한 요청과 응답을 다음 필터에 전달한다.

* 필터의 적용 순서는 요청과 응답에서 반대로 적용된다.

필터를 구현하는 데 있어 핵심은 다음 3개의 타입이다.

## Filter 인터페이스

필터가 구현해야하는 인터페이스이다.

|메소드||
|---|---|
|init()|필터 초기화 메소드, 서블릿 컨테이너가 생성될 때 호출된다.|
|doFilter()|필터의 로직을 가지는 메소드, 요청이 있을 때마다 매번 호출된다.|
|destroy()|필터 종료 메소드, 서블릿 컨테이너가 종료될 때 호출된다.|

## ServletRequestWrapper

요청을 변경한 결과를 저장하는 래퍼 클래스

* 클라이언트의 요청을 변경하기 위해 사용한다.

* 요청 정보를 변경하여 최종 자원인 서블릿, JSP에 전달한다.

## ServletResponseWrapper

응답을 변경하기 위해 사용하는 래퍼 클래스

* 클라이언트로가는 응답을 변경하기 위해 사용한다.

* 최종 자원으로부터의 응답을 변경하여 새로운 응답 정보를 클라이언트에 보낸다.

# 인터셉터

스프링 MVC가 제공하는 기술로 스프링 MVC 구조에 특화된 기능을 제공한다. 필터와 마찬가지로 웹과 관련된 공통 관심 사항을 처리하지만 적용되는 순서와 범위, 그리고 사용방법이 다르다.

* 인터셉터는 디스패처 서블릿과 컨트롤러 사이에서 컨트롤러 호출 직전에 호출 된다.

* 필터와 마찬가지로 여러 개의 인터셉터를 가질 수 있다.

#### 스프링 인터셉터의 정상 흐름

![Alt text](<이미지/인터셉터.png>)

#### preHandle

컨트롤러(핸들러) 호출 전에 호출된다. preHandle의 응답값이 true일 경우 다음으로 진행하고, false인 경우는 나머지 인터셉터와 컨트롤러 모두 호출되지 않는다.

#### postHandle

컨트롤러 호출 후에 호출되며, 컨트롤러에서 예외가 발생하면 호출되지 않는다.

#### afterCompletion

뷰 렌더링 이후에 호출되며, 컨트롤러에서 예외가 발생해도 호출된다. 따라서 항상 처리되어야 하는 작업은 afterCompletion()을 사용하면 된다.

# 필터와 인터셉터의 차이

## 필터

* request와 response를 wrapper로 변경해서 작업을 처리하고 전달할 수 있다.

## 인터셉터

* addPathPatterns() 메소드와 excludePathPatterns() 메소드를 사용해 편리하게 경로를 설정할 수 있다.

* URL 패턴을 서블릿보다 더 정밀하게 설정할 수 있다.<br>예를 들면 '?'를 사용해서 문자 하나에 대해서만 패턴을 지정할 수도 있다.
    ```
    /pages/t?st.html — matches /pages/test.html as well as /pages/tXst.html
                       but not /pages/toast.html
    ```

* 필터는 작업처리를 위해 doFilter() 하나만 제공되지만, 인터셉터는 컨트롤러 호출 전후, 요청 완료 이후와 같이 단계적으로 세분화 되어 있다.

* 인터셉터는 request , response 정보 뿐만 아니라 호출된 컨트롤러(핸들러)와 modelAndView의 정보도 받을 수 있다.

따라서 스프링 MVC를 사용하고, 특별히 필터를 꼭 사용해야 하는 상황이 아니라면 인터셉터를 사용하는 것이 더 편리하다.